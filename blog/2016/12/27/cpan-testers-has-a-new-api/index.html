<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link href="/theme/css/normalize.css" rel="stylesheet">
        <link href="/theme/css/skeleton.css" rel="stylesheet">
        <link href="/theme/css/statocles-default.css" rel="stylesheet">
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
        <title>CPAN Testers Has a New API - preaction</title>
        <meta content="Statocles 0.083" name="generator">
        <link href="http://blogs.perl.org/users/preaction/2016/12/cpan-testers-has-a-new-api.html" rel="canonical">
        
    </head>
    <body>
        <header>
            <nav class="navbar">
                <div class="container">
                    <a class="brand" href="/">preaction</a>
                    <ul>
                        <li>
                            <a href="/index.html">Blog</a>
                        </li>
                        <li>
                            <a href="/resume">Resume</a>
                        </li>
                        <li>
                            <a href="/talks">Talks</a>
                        </li>
                        <li>
                            <a href="/statocles">Statocles</a>
                        </li>
                        <li>
                            <a href="/yertl">Yertl</a>
                        </li>
                        <li>
                            <a href="http://indiepalate.com">Food</a>
                        </li>
                    </ul>
                    
                </div>
            </nav>
            
        </header>
        <div class="main container">
            <div class="row">

    <div class="nine columns">
        <main>
            <header>
                <h1>CPAN Testers Has a New API</h1>
                <p class="tags">Tags:
                    <a href="/blog/tag/perl/" rel="tag">perl</a>
                    <a href="/blog/tag/cpantesters/" rel="tag">cpantesters</a>
                </p>

                <aside>
                    <p><time datetime="2016-12-27">
                        Posted on 2016-12-27
                    </time>
                    </p>
                </aside>


            </header>
            <section id="section-1">
                <p>As part of <a href="https://metacpan.org/about/meta_hack">the MetaCPAN hackathon,
meta::hack</a>, I was invited to work
on the CPAN Testers integration. <a href="http://cpantesters.org">CPAN Testers</a>
is a community of <a href="http://cpan.org">CPAN</a> users who send in test reports
for CPAN modules as they are uploaded. <a href="http://metacpan.org">MetaCPAN</a>
adds a summary of those test reports to every CPAN distribution to help
you determine which module you&#39;d most like to use. For quite a few
months, this integration was broken, and the nature of the current
integration (a SQLite database) means it is not as generally useful as
it could be.</p>

<p>So, I decided that the best way to improve the CPAN Testers / MetaCPAN
integration was to build a <a href="http://api.cpantesters.org">new CPAN Testers
API</a>. This API uses <a href="http://metacpan.org/pod/CPAN::Testers::Schema">the CPAN Testers
schema</a> to expose CPAN
Testers data using a JSON API. This API is built using <a href="http://mojolicious.org">the Mojolicious
web framework</a>, and an <a href="http://openapis.org">OpenAPI
specification</a> (using
<a href="http://metacpan.org/pod/Mojolicious::Plugin::OpenAPI">Mojolicious::Plugin::OpenAPI</a>.</p>

            </section>
            <section id="section-2">
                <p>Documenting the API using the <a href="http://openapis.org">OpenAPI</a> language
automatically generates the application routes, and makes input and
output validation very simple (all handled by
<a href="http://metacpan.org/pod/Mojolicious::Plugin::OpenAPI">Mojolicious::Plugin::OpenAPI</a>).
Having the API specification be a simple JSON document also makes it
possible to <a href="http://api.cpantesters.org/docs">automatically generate
documentation</a> and display it using
<a href="http://swagger.io/swagger-ui">Swagger-UI</a>. The Swagger-UI tool even
allows users to try out the API right in the browser, displays the input
parameters and their documentation, and gives you real output based on
the request you input.</p>

<p>Right now, the CPAN Testers API has access to only some of the data CPAN
Testers has:</p>

<ul>
<li>The <a href="http://api.cpantesters.org/docs/?url=/v1#!/Release">/release</a>
data collects <a href="http://api.cpantesters.org/docs/?url=/v1#!/Release/release_all">test report summaries for all of
CPAN</a>,
or you can limit <a href="http://api.cpantesters.org/docs/?url=/v1#!/Release/release_dist">releases by
dist</a>
or <a href="http://api.cpantesters.org/docs/?url=/v1#!/Release/release_author">releases by
author</a>
(good for making CPAN dashboards).</li>
<li>The <a href="http://api.cpantesters.org/docs/?url=/v1#!/Upload">/upload</a> data
shows <a href="http://api.cpantesters.org/docs/?url=/v1#!/Upload/upload_all">all uploads to
CPAN</a>,
which you can limit to <a href="http://api.cpantesters.org/docs/?url=/v1#!/Upload/upload_dist">uploads by
dist</a>
or <a href="http://api.cpantesters.org/docs/?url=/v1#!/Upload/upload_author">uploads by
author</a>.</li>
</ul>

<p>These APIs can be easily used by any HTTP client, and since they return
JSON, can be easily manipulated with simple tools like
<a href="https://stedolan.github.io/jq/"><code>jq</code></a> or
<a href="http://preaction.me/yertl/">ETL::Yertl</a>:</p>

<pre><code># Get all test data for every release of the CPAN-Testers-API distribution
curl &#39;http://api.cpantesters.org/v1/release/dist/CPAN-Testers-API&#39;

# Get all Statocles release test data updated since the beginning of 2016
curl &#39;http://api.cpantesters.org/v1/release/dist/Statocles?since=2016-01-01T00:00:00&#39;

# Select all of my releases where there was a failure report
curl http://api.cpantesters.org/v1/release/author/PREACTION | jq &#39;.[] | select( .fail &gt; 1 )&#39;

# Build my own database for personal use!
sqlite3 data.db &#39;CREATE TABLE release ( dist VARCHAR, version VARCHAR, pass INTEGER, fail INTEGER, na INTEGER, unknown INTEGER )&#39;
curl http://api.cpantesters.org/v1/release/author/PREACTION | yfrom json | yq &#39;.[]&#39; | ysql --dsn dbi:SQLite:data.db --insert release
# ... and then find failed dists
ysql --dsn dbi:SQLite:data.db --select release --where &#39;fail &gt; 100&#39;
</code></pre>

<p>In addition to these standard JSON API calls, the new CPAN Testers API
also provides a WebSocket API for getting push notifications of
important CPAN Testers events. With just a WebSocket and a JSON parser,
you can subscribe to a WebSocket feed of new uploads to CPAN. In the
future, all internal CPAN Testers communication will be done through the
API using the <a href="http://preaction.me/mercury">Mercury message broker</a> on
the backend, allowing you to use simple WebSockets to build your own
data alerts and updates.</p>

<p>Any WebSocket client can connect to get updates, like so:</p>

<pre><code># feed.pl from https://github.com/cpan-testers/cpantesters-api/blob/master/eg/feed.pl
$ perl feed.pl http://api.cpantesters.org/v1/upload
Got upload: Mercury (0.011) by PREACTION
</code></pre>

<p>Once the message is send on the websocket, the archive is available on
CPAN Testers CPAN mirror (http://cpan.cpantesters.org), so you could
immediately start testing it and sending in reports (hint hint)!</p>

<p>This is just the start of what this API could be made to do. If you&#39;d
like to use some CPAN Testers data, but it is not yet available from the
API, check <a href="https://github.com/cpan-testers/cpantesters-api/blob/master/CONTRIBUTING.md">our contributing
guide</a>
for how to add new features, and if you have questions <a href="https://github.com/cpan-testers/cpantesters-api/blob/master/CONTRIBUTING.md#communication">here&#39;s how to
get in
contact</a>.</p>

<p>If you&#39;d like to help, but don&#39;t know how, here&#39;s some possible features
that could be implemented to make the API easier to use:</p>

<ul>
<li>You can make the post-filters I use <code>jq</code> and ETL::Yertl for into API
query parameters so that I can directly request only the releases with
more than 10 failure reports</li>
<li>You could make a special filter to only include the latest version of
the dist</li>
<li>You could add more endpoints to filter the data:
<ul>
<li><code>/release/dist/{dist}/{version}</code> and
<code>/upload/dist/{dist}/{version}</code> to only get a single version</li>
<li><code>/release/dist/{dist}/latest</code> and <code>/upload/dist/{dist}/latest</code> to
get the latest version</li>
</ul></li>
</ul>

<p>As always <a href="http://iheart.cpantesters.org">thanks to all the sponsors of CPAN
Testers</a>, and specifically to the
<a href="https://metacpan.org/about/meta_hack">sponsors of meta::hack for providing the means to get this API
started</a>.</p>

            </section>
        </main>

        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'preaction';
            var disqus_identifier = '/2016/12/27/cpan-testers-has-a-new-api/index.markdown';
            var disqus_url = 'http://preaction.me/blog/2016/12/27/cpan-testers-has-a-new-api/';
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    </div>

    <div class="three columns sidebar">
        
<img alt="avatar" src="/images/avatar-small.jpg" title="Do You Believe In Magic? by Fusspot">

<h1>Doug Bell</h1>

<ul class="bare">
    <li><a href="https://github.com/preaction">
        <i class="fa fa-github-alt"></i> Github: preaction
    </a></li>
    <li><a href="https://twitter.com/preaction">
        <i class="fa fa-twitter"></i>Twitter: preaction
    </a></li>
    <li><a href="https://metacpan.org/author/PREACTION">CPAN: preaction</a></li>
</ul>

        <nav id="tags">
            <h1>Tags</h1>
            <ul class="list-inline">
                <li><a href="/blog/tag/beam/">beam</a></li>
                <li><a href="/blog/tag/blacklivesmatter/">blacklivesmatter</a></li>
                <li><a href="/blog/tag/chicago-pm/">chicago.pm</a></li>
                <li><a href="/blog/tag/code/">code</a></li>
                <li><a href="/blog/tag/community/">community</a></li>
                <li><a href="/blog/tag/cpan/">cpan</a></li>
                <li><a href="/blog/tag/cpantesters/">cpantesters</a></li>
                <li><a href="/blog/tag/error/">error</a></li>
                <li><a href="/blog/tag/etl/">etl</a></li>
                <li><a href="/blog/tag/funny/">funny</a></li>
                <li><a href="/blog/tag/git/">git</a></li>
                <li><a href="/blog/tag/history/">history</a></li>
                <li><a href="/blog/tag/javascript/">javascript</a></li>
                <li><a href="/blog/tag/logging/">logging</a></li>
                <li><a href="/blog/tag/mojolicious/">mojolicious</a></li>
                <li><a href="/blog/tag/moose/">moose</a></li>
                <li><a href="/blog/tag/mysql/">mysql</a></li>
                <li><a href="/blog/tag/openbsd/">openbsd</a></li>
                <li><a href="/blog/tag/perl/">perl</a></li>
                <li><a href="/blog/tag/personal/">personal</a></li>
                <li><a href="/blog/tag/progress/">progress</a></li>
                <li><a href="/blog/tag/racism/">racism</a></li>
                <li><a href="/blog/tag/rants/">rants</a></li>
                <li><a href="/blog/tag/scripts/">scripts</a></li>
                <li><a href="/blog/tag/software/">software</a></li>
                <li><a href="/blog/tag/sql/">sql</a></li>
                <li><a href="/blog/tag/statocles/">statocles</a></li>
                <li><a href="/blog/tag/travel/">travel</a></li>
                <li><a href="/blog/tag/webgui/">webgui</a></li>
                <li><a href="/blog/tag/webundesign/">webundesign</a></li>
                <li><a href="/blog/tag/xs/">xs</a></li>
                <li><a href="/blog/tag/yertl/">yertl</a></li>
            </ul>
        </nav>
    </div>

</div>

        </div>
        <footer>
            
            <div class="container tagline">
                <a href="http://preaction.me/statocles">Made with Statocles</a><br>
                <a href="http://www.perl.org">Powered by Perl</a>
            </div>
        </footer>
    </body>
</html>
