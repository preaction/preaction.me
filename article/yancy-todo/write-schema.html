<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link href="/theme/css/normalize.css" rel="stylesheet">
        <link href="/theme/css/skeleton.css" rel="stylesheet">
        <link href="/theme/css/statocles-default.css" rel="stylesheet">
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
        <title>Create Schema - Todo App - Yancy Tutorial - preaction</title>
        <meta content="Statocles 0.093" name="generator">
        
    </head>
    <body>
        <header>
            <nav class="navbar">
                <div class="container">
                    <a class="brand" href="/">preaction</a>
                    <ul>
                        <li>
                            <a href="/index.html">Blog</a>
                        </li>
                        <li>
                            <a href="/resume">Resume</a>
                        </li>
                        <li>
                            <a href="/talks">Talks</a>
                        </li>
                        <li>
                            <a href="/statocles">Statocles</a>
                        </li>
                        <li>
                            <a href="/yertl">Yertl</a>
                        </li>
                        <li>
                            <a href="http://indiepalate.com">Food</a>
                        </li>
                    </ul>
                    
                </div>
            </nav>
            
        </header>
        <div class="main container">
            

<ul class="pager">
    <li class="prev">
        <a class="button" href="start-lite-app.html">
            &lt; 2. Start a new Mojolicious application
        </a>
    </li>
    <li class="next">
        <a class="button button-primary" href="add-yancy.html">
            4. Add and configure Yancy &gt;
        </a>
    </li>
</ul>

<main>
    <h1>Create the Schema</h1>

<p>Before we can develop our web app to manipulate data, we need to figure
out what our data looks like.</p>

<blockquote>
  <p>Show me your flowcharts and conceal your tables, and I shall continue
  to be mystified. Show me your tables, and I won’t usually need your
  flowcharts; they’ll be obvious. -- Fred Brooks, The Mythical Man-Month</p>
</blockquote>

<h2>Setup Postgres</h2>

<p>We could choose a lot of data stores for this simple project: SQLite
would be perfect, MySQL would work fine. We&#39;re choosing Postgres for no
particular reason except for the Mojo::Pg project being officially part
of the Mojolicious project.</p>

<p>So, once we&#39;ve installed Postgres, we&#39;ll need to initialize a database
for us to use. If you installed Postgres through your package manager,
it might have come with a default database. If not, Postgres comes with
an <code>initdb</code> command which will initialize a database in a directory. For
example, we could run <code>initdb db</code> to initialize the database in the <code>db</code>
directory. Once the database is initialized, we can run a database
daemon with <code>pg_ctl -D db -l db.log start</code>.</p>

<p>Once Postgres is running, we can create a database for our application
with the <code>createdb</code> command: <code>createdb myapp</code>.</p>

<p>Now we need to populate that database with some tables to store our
data.</p>

<h2>Plan Schema</h2>

<p>We need two tables.</p>

<ol>
<li>A place to store things to do and how often we have to do them</li>
<li>A place to store the things we did or didn&#39;t do</li>
</ol>

<p>The things to do is going to be the most complicated. Remember, we want
to be able to specify tasks to do every <code>$n</code> days, weeks, and months.
So, each thing to do has a day where it&#39;s made available to do, and
a period in which we display it. After the period is over, we no longer
display the item.</p>

<p>So we give each to-do item a period: &quot;day&quot;, &quot;week&quot;, or &quot;month&quot;. And an
interval, an integer which says how many periods to skip: &quot;1 day&quot; is
daily, &quot;2 weeks&quot; is bi-weekly. The interval also tells us how long to
display the item: An item that should be done every &quot;2 days&quot; should
appear for one day out of every two, and an item that should be done
every &quot;2 weeks&quot; should appear for one week out of two. Finally, a start
date of when we created this item.</p>

<pre><code>CREATE TYPE todo_interval AS ENUM ( &#39;day&#39;, &#39;week&#39;, &#39;month&#39; );
CREATE TABLE todo_item (
    id SERIAL PRIMARY KEY,
    title TEXT,
    period todo_interval NOT NULL,
    interval INTEGER DEFAULT 1 CHECK ( interval &gt;= 1 ) NOT NULL,
    start_date DATE NOT NULL DEFAULT CURRENT_DATE
);
</code></pre>

<p>Now we need the log of the things we did. This will also be a log of the
things we need to do, and the things we didn&#39;t do. Every day we will add
to the log. Each item in the log should have a start and end date, which
represents the period we display the thing. And we should store the day
we completed the thing (which will be <code>null</code> if we have not completed
the thing).</p>

<pre><code>CREATE TABLE todo_log (
    id SERIAL PRIMARY KEY,
    todo_item_id INTEGER REFERENCES todo_item ( id ) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    complete DATE DEFAULT NULL
);
</code></pre>

<p>Mojo::Pg has an easy way of allowing us to upgrade (and downgrade) our database
called &quot;migrations&quot;. To use it, we create a new file in our <code>__DATA__</code> section
called <code>migrations</code>. Inside that, we create a section called <code>-- 1 up</code> to
upgrade to version 1 of our database, and <code>-- 1 down</code> to downgrade from version
1 of our database.</p>

<pre><code>@@ migrations
-- 1 up
CREATE TYPE todo_interval AS ENUM ( &#39;day&#39;, &#39;week&#39;, &#39;month&#39; );
CREATE TABLE todo_item (
    id SERIAL PRIMARY KEY,
    title TEXT,
    period todo_interval NOT NULL,
    interval INTEGER DEFAULT 1 CHECK ( interval &gt;= 1 ) NOT NULL,
    start_date DATE NOT NULL DEFAULT CURRENT_DATE
);
CREATE TABLE todo_log (
    id SERIAL PRIMARY KEY,
    todo_item_id INTEGER REFERENCES todo_item ( id ) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    complete DATE DEFAULT NULL
);
-- 1 down
DROP TABLE todo_item;
DROP TABLE todo_log;
DROP TYPE todo_interval;
</code></pre>

<p>Then we have to make Mojo::Pg migrate our database. For that we need a database
connection, which we will create a helper for. Helpers are subroutines that are
available to us throughout our application, which definitely describes what we
want our database connection to do.</p>

<pre><code>#!/usr/bin/env perl
use Mojolicious::Lite;
use Mojo::Pg;
helper pg =&gt; sub { state $pg = Mojo::Pg-&gt;new( &#39;postgres:///myapp&#39; ) };
</code></pre>

<p>Now we can tell Mojo::Pg to automatically migrate, and then tell it where our
migrations are:</p>

<pre><code>app-&gt;pg-&gt;auto_migrate(1)-&gt;migrations-&gt;from_data;
</code></pre>

<p>Now if we ever add a version 2 of our database, we will be automatically
migrated to it.</p>

<p>Here&#39;s our full app so far:</p>

<pre><code>#!/usr/bin/env perl
use Mojolicious::Lite;
use Mojo::Pg;
helper pg =&gt; sub { state $pg = Mojo::Pg-&gt;new( &#39;postgres:///myapp&#39; ) };
app-&gt;pg-&gt;auto_migrate(1)-&gt;migrations-&gt;from_data;
get &#39;/&#39; =&gt; &#39;index&#39;;
app-&gt;start;
__DATA__
@@ index.html.ep
% layout &#39;default&#39;;
% title &#39;My Application&#39;;
Hello, world!
@@ layouts/default.html.ep
&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;&lt;title&gt;&lt;%= title %&gt;&lt;/title&gt;&lt;/head&gt;
    &lt;body&gt;
        %= content
    &lt;/body&gt;
&lt;/html&gt;
@@ migrations
-- 1 up
CREATE TYPE todo_interval AS ENUM ( &#39;day&#39;, &#39;week&#39;, &#39;month&#39; );
CREATE TABLE todo_item (
    id SERIAL PRIMARY KEY,
    title TEXT,
    period todo_interval NOT NULL,
    interval INTEGER DEFAULT 1 CHECK ( interval &gt;= 1 ) NOT NULL,
    start_date DATE NOT NULL DEFAULT CURRENT_DATE
);
CREATE TABLE todo_log (
    id SERIAL PRIMARY KEY,
    todo_item_id INTEGER REFERENCES todo_item ( id ) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    complete DATE DEFAULT NULL
);
-- 1 down
DROP TABLE todo_log;
DROP TABLE todo_item;
DROP TYPE todo_interval;
</code></pre>

</main>

<ul class="pager">
    <li class="prev">
        <a class="button" href="start-lite-app.html">
            &lt; 2. Start a new Mojolicious application
        </a>
    </li>
    <li class="next">
        <a class="button button-primary" href="add-yancy.html">
            4. Add and configure Yancy &gt;
        </a>
    </li>
</ul>


        </div>
        <footer>
            
            <div class="container tagline">
                <a href="http://preaction.me/statocles">Made with Statocles</a><br>
                <a href="http://www.perl.org">Powered by Perl</a>
            </div>
        </footer>
    </body>
</html>
